Original code by Fabio Baresano <fvaresano@yahoo.it>
Modified for libmaple by Mark Goodall <markit@seken.co.uk>
